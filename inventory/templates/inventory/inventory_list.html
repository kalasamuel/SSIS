{% extends 'inventory/base.html' %}
{% block title %}Inventory Management - Supermarket DBMS{% endblock %}
{% block content %}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>Inventory Management</h2>
    <p class="text-muted mb-0">Track stock levels, transactions, and reorder alerts</p>
  </div>
  <div class="btn-group">
    <a href="{% url 'log_inventory' %}" class="btn btn-primary">
      <i class="fas fa-plus me-2"></i>Add Stock Movement
    </a>
    <button class="btn btn-outline-secondary" onclick="printInventory()">
      <i class="fas fa-print me-2"></i>Print
    </button>
  </div>
</div>


<!-- Filters and Search -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Search Products</label>
        <input type="text" class="form-control" id="searchInput" placeholder="Search by name, brand, or category...">
      </div>
      <div class="col-md-2">
        <label class="form-label">Stock Status</label>
        <select id="stockFilter" class="form-select">
          <option value="">All</option>
          <option value="in-stock">In Stock</option>
          <option value="low-stock">Low Stock</option>
          <option value="out-of-stock">Out of Stock</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Category</label>
        <select id="categoryFilter" class="form-select">
          <option value="">All Categories</option>
          <!-- Categories will be populated by JavaScript -->
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Supplier</label>
        <select id="supplierFilter" class="form-select">
          <option value="">All Suppliers</option>
          <!-- Suppliers will be populated by JavaScript -->
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" onclick="applyFilters()">
          <i class="fas fa-filter me-2"></i>Apply Filters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Inventory Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Product Inventory</h5>
    <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-primary" onclick="exportInventory('csv')">
        <i class="fas fa-file-csv me-1"></i>Export CSV
      </button>
      <button class="btn btn-outline-secondary" onclick="exportInventory('pdf')">
        <i class="fas fa-file-pdf me-1"></i>Export PDF
      </button>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="inventoryTable">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>Category</th>
            <th>Supplier</th>
            <th>Current Stock</th>
            <th>Reorder Level</th>
            <th>Unit Cost</th>
            <th>Retail Price</th>
            <th>Expiry Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="inventoryTableBody">
          <!-- Data will be loaded dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Transaction Logs Section -->
<div class="card mt-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Recent Stock Movements</h5>
    <button class="btn btn-outline-primary btn-sm" onclick="refreshTransactionLogs()">
      <i class="fas fa-sync me-1"></i>Refresh
    </button>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="transactionTable">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Product</th>
            <th>Movement Type</th>
            <th>Quantity</th>
            <th>Staff</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="transactionTableBody">
          <!-- Data will be loaded dynamically -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal fade" id="adjustmentModal" tabindex="-1" aria-labelledby="adjustmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adjustmentModalLabel">Adjust Stock Quantity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="adjustmentForm">
          <input type="hidden" id="adjustProductId">
          <div class="mb-3">
            <label class="form-label">Product</label>
            <input type="text" class="form-control" id="adjustProductName" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Current Stock</label>
            <input type="number" class="form-control" id="adjustCurrentStock" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Adjustment Type</label>
            <select class="form-select" id="adjustmentType" required>
              <option value="">Select Type</option>
              <option value="increase">Increase Stock</option>
              <option value="decrease">Decrease Stock</option>
              <option value="set">Set Exact Quantity</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" id="adjustmentQuantity" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Remarks</label>
            <textarea class="form-control" id="adjustmentRemarks" rows="3" placeholder="Reason for adjustment..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitStockAdjustment()">Apply Adjustment</button>
      </div>
    </div>
  </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="productDetailsBody">
        <!-- Content will be loaded dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
// Global variables
let products = [];
let categories = [];
let suppliers = [];
let transactionLogs = [];

// Load inventory data
async function loadInventoryData() {
  try {
    const response = await fetch('/inventory/api/products/');
    const data = await response.json();
    products = data.products || [];
    categories = data.categories || [];
    suppliers = data.suppliers || [];
    
    populateFilters();
    displayInventoryTable();
    calculateSummary();
  } catch (error) {
    console.error('Error loading inventory data:', error);
  }
}

// Load transaction logs
async function loadTransactionLogs() {
  try {
    const response = await fetch('/inventory/api/transactions/');
    const data = await response.json();
    transactionLogs = data.transactions || [];
    displayTransactionTable();
  } catch (error) {
    console.error('Error loading transaction logs:', error);
  }
}

// Populate filter dropdowns
function populateFilters() {
  const categorySelect = document.getElementById('categoryFilter');
  const supplierSelect = document.getElementById('supplierFilter');
  
  // Clear existing options
  categorySelect.innerHTML = '<option value="">All Categories</option>';
  supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
  
  // Add categories
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.id;
    option.textContent = category.name;
    categorySelect.appendChild(option);
  });
  
  // Add suppliers
  suppliers.forEach(supplier => {
    const option = document.createElement('option');
    option.value = supplier.id;
    option.textContent = supplier.name;
    supplierSelect.appendChild(option);
  });
}

// Display inventory table
function displayInventoryTable() {
  const tbody = document.getElementById('inventoryTableBody');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const stockFilter = document.getElementById('stockFilter').value;
  const categoryFilter = document.getElementById('categoryFilter').value;
  const supplierFilter = document.getElementById('supplierFilter').value;
  
  let filteredProducts = products.filter(product => {
    const matchesSearch = !searchTerm || 
      product.product_name.toLowerCase().includes(searchTerm) ||
      product.brand.toLowerCase().includes(searchTerm) ||
      product.category_name.toLowerCase().includes(searchTerm);
    
    const matchesStock = !stockFilter || 
      (stockFilter === 'in-stock' && product.stock_quantity > product.reorder_level) ||
      (stockFilter === 'low-stock' && product.stock_quantity <= product.reorder_level && product.stock_quantity > 0) ||
      (stockFilter === 'out-of-stock' && product.stock_quantity === 0);
    
    const matchesCategory = !categoryFilter || product.category_id == categoryFilter;
    const matchesSupplier = !supplierFilter || product.supplier_id == supplierFilter;
    
    return matchesSearch && matchesStock && matchesCategory && matchesSupplier;
  });
  
  tbody.innerHTML = filteredProducts.map(product => {
    const stockStatus = getStockStatus(product.stock_quantity, product.reorder_level);
    const statusBadge = getStatusBadge(stockStatus);
    
    return `
      <tr>
        <td>
          <div class="d-flex align-items-center">
            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
              <i class="fas fa-box text-white"></i>
            </div>
            <div>
              <h6 class="mb-0">${product.product_name}</h6>
              <small class="text-muted">${product.brand || 'No brand'} - ${product.unit}</small>
            </div>
          </div>
        </td>
        <td>${product.category_name}</td>
        <td>${product.supplier_name}</td>
        <td class="text-end">
          <span class="fw-bold ${stockStatus === 'out-of-stock' ? 'text-danger' : stockStatus === 'low-stock' ? 'text-warning' : 'text-success'}">
            ${product.stock_quantity.toLocaleString()}
          </span>
        </td>
        <td class="text-end">${product.reorder_level.toLocaleString()}</td>
        <td class="text-end">UGx. ${parseFloat(product.unit_cost).toLocaleString()}</td>
        <td class="text-end">UGx. ${parseFloat(product.retail_price).toLocaleString()}</td>
        <td>${product.expiry_date ? new Date(product.expiry_date).toLocaleDateString() : 'N/A'}</td>
        <td>${statusBadge}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="viewProductDetails(${product.id})" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-warning" onclick="adjustStock(${product.id})" title="Adjust Stock">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline-info" onclick="viewProductTransactions(${product.id})" title="View Transactions">
              <i class="fas fa-history"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Display transaction table
function displayTransactionTable() {
  const tbody = document.getElementById('transactionTableBody');
  
  tbody.innerHTML = transactionLogs.slice(0, 20).map(log => {
    const typeBadge = getTransactionTypeBadge(log.log_type);
    
    return `
      <tr>
        <td>${new Date(log.log_date).toLocaleString()}</td>
        <td>${log.product_name}</td>
        <td>${typeBadge}</td>
        <td class="text-end ${log.log_type === 'Sale' ? 'text-danger' : 'text-success'}">
          ${log.log_type === 'Sale' ? '-' : '+'}${log.quantity}
        </td>
        <td>${log.staff_name}</td>
        <td>${log.remarks || '-'}</td>
      </tr>
    `;
  }).join('');
}

// Get stock status
function getStockStatus(currentStock, reorderLevel) {
  if (currentStock === 0) return 'out-of-stock';
  if (currentStock <= reorderLevel) return 'low-stock';
  return 'in-stock';
}

// Get status badge
function getStatusBadge(status) {
  const badges = {
    'in-stock': '<span class="badge bg-success">In Stock</span>',
    'low-stock': '<span class="badge bg-warning">Low Stock</span>',
    'out-of-stock': '<span class="badge bg-danger">Out of Stock</span>'
  };
  return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

// Get transaction type badge
function getTransactionTypeBadge(type) {
  const badges = {
    'Purchase': '<span class="badge bg-success">Purchase</span>',
    'Sale': '<span class="badge bg-danger">Sale</span>',
    'Adjustment': '<span class="badge bg-warning">Adjustment</span>'
  };
  return badges[type] || '<span class="badge bg-secondary">Unknown</span>';
}

// Calculate summary statistics
function calculateSummary() {
  const totalProducts = products.length;
  const inStockProducts = products.filter(p => p.stock_quantity > p.reorder_level).length;
  const lowStockProducts = products.filter(p => p.stock_quantity <= p.reorder_level && p.stock_quantity > 0).length;
  const outOfStockProducts = products.filter(p => p.stock_quantity === 0).length;
  
  document.getElementById('totalProducts').textContent = totalProducts;
  document.getElementById('inStockProducts').textContent = inStockProducts;
  document.getElementById('lowStockProducts').textContent = lowStockProducts;
  document.getElementById('outOfStockProducts').textContent = outOfStockProducts;
}

// Apply filters
function applyFilters() {
  displayInventoryTable();
}

// Adjust stock
function adjustStock(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  document.getElementById('adjustProductId').value = productId;
  document.getElementById('adjustProductName').value = product.product_name;
  document.getElementById('adjustCurrentStock').value = product.stock_quantity;
  document.getElementById('adjustmentType').value = '';
  document.getElementById('adjustmentQuantity').value = '';
  document.getElementById('adjustmentRemarks').value = '';
  
  const modal = new bootstrap.Modal(document.getElementById('adjustmentModal'));
  modal.show();
}

// Submit stock adjustment
async function submitStockAdjustment() {
  const productId = document.getElementById('adjustProductId').value;
  const adjustmentType = document.getElementById('adjustmentType').value;
  const quantity = parseInt(document.getElementById('adjustmentQuantity').value);
  const remarks = document.getElementById('adjustmentRemarks').value;
  
  if (!adjustmentType || !quantity || quantity <= 0) {
    alert('Please fill in all required fields with valid values.');
    return;
  }
  
  try {
    const response = await fetch('/inventory/adjust-stock/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({
        product_id: productId,
        adjustment_type: adjustmentType,
        quantity: quantity,
        remarks: remarks
      })
    });
    
    const result = await response.json();
    if (result.success) {
      // Close modal and refresh data
      const modal = bootstrap.Modal.getInstance(document.getElementById('adjustmentModal'));
      modal.hide();
      
      // Refresh inventory data
      await loadInventoryData();
      await loadTransactionLogs();
      
      alert('Stock adjustment applied successfully.');
    } else {
      alert('Error applying stock adjustment: ' + result.error);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error applying stock adjustment.');
  }
}

// View product details
async function viewProductDetails(productId) {
  try {
    const response = await fetch(`/inventory/product-details/${productId}/`);
    const data = await response.json();
    
    const modalBody = document.getElementById('productDetailsBody');
    modalBody.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6>Product Information</h6>
          <p><strong>Name:</strong> ${data.product_name}</p>
          <p><strong>Brand:</strong> ${data.brand || 'N/A'}</p>
          <p><strong>Unit:</strong> ${data.unit}</p>
          <p><strong>Category:</strong> ${data.category_name}</p>
          <p><strong>Supplier:</strong> ${data.supplier_name}</p>
        </div>
        <div class="col-md-6">
          <h6>Stock Information</h6>
          <p><strong>Current Stock:</strong> ${data.stock_quantity.toLocaleString()}</p>
          <p><strong>Reorder Level:</strong> ${data.reorder_level.toLocaleString()}</p>
          <p><strong>Unit Cost:</strong> UGx. ${parseFloat(data.unit_cost).toLocaleString()}</p>
          <p><strong>Retail Price:</strong> UGx. ${parseFloat(data.retail_price).toLocaleString()}</p>
          <p><strong>Expiry Date:</strong> ${data.expiry_date ? new Date(data.expiry_date).toLocaleDateString() : 'N/A'}</p>
        </div>
      </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
    modal.show();
  } catch (error) {
    console.error('Error loading product details:', error);
    alert('Error loading product details');
  }
}

// View product transactions
function viewProductTransactions(productId) {
  // This could open a modal or redirect to a detailed transaction view
  window.location.href = `/inventory/product-transactions/${productId}/`;
}

// Export functions
function exportInventory(format) {
  const url = `/inventory/export/?format=${format}`;
  window.open(url, '_blank');
}

// Refresh transaction logs
function refreshTransactionLogs() {
  loadTransactionLogs();
}

// Print function
function printInventory() {
  window.print();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  loadInventoryData();
  loadTransactionLogs();
  
  // Add event listeners
  document.getElementById('searchInput').addEventListener('input', displayInventoryTable);
  document.getElementById('stockFilter').addEventListener('change', displayInventoryTable);
  document.getElementById('categoryFilter').addEventListener('change', displayInventoryTable);
  document.getElementById('supplierFilter').addEventListener('change', displayInventoryTable);
});
</script>

<style>
.avatar-sm {
  width: 32px;
  height: 32px;
  font-size: 14px;
}

@media print {
  .btn, .modal, .card-header .btn-group {
    display: none !important;
  }
  
  .card {
    border: none !important;
    box-shadow: none !important;
  }
}

.table th {
  border-top: none;
}

.badge {
  font-size: 0.75em;
}

.text-success { color: #28a745 !important; }
.text-warning { color: #ffc107 !important; }
.text-danger { color: #dc3545 !important; }
</style>

{% endblock %}
