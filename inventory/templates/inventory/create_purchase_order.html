{% extends 'inventory/base.html' %}
{% block title %}Create Purchase Order - Supermarket DBMS{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="fw-bold mb-3 text-success">New Purchase Order</h2>
  <p class="text-muted">Fill out the form below to create a new purchase order.</p>

  <form method="POST" id="orderForm">
    {% csrf_token %}

    <!-- Supplier Section -->
    <div class="card p-3 mb-4">
      <h5>Supplier Information</h5>
      <div class="row">
        <div class="col-md-6">
          <label for="supplier" class="form-label">Supplier</label>
          <select name="supplier" id="supplier" class="form-select" required>
            <option value="">Select Supplier</option>
            {% for supplier in suppliers %}
              <option value="{{ supplier.id }}"
              data-email="{{ supplier.email }}"
              data-phone="{{ supplier.phone }}"
              >{{ supplier.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6" id="supplierInfo" style="display:none;">
          <div class="border rounded p-2 mt-2 bg-light">
            <p><strong>Phone:</strong> <span id="supplierPhone"></span></p>
            <p><strong>Email:</strong> <span id="supplierEmail"></span></p>
          </div>
        </div>
        <div class="col-md-3">
          <label for="expected_delivery_date" class="form-label">Expected Delivery Date</label>
          <input type="date" name="expected_delivery_date" id="expected_delivery_date" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="invoice_no" class="form-label">Invoice Number</label>
          <input type="text" name="invoice_no" id="invoice_no" class="form-control" placeholder="Optional">
        </div>
      </div>
    </div>

    <!-- Product Items Section -->
    <div class="card p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Products</h5>
        <button type="button" class="btn btn-sm btn-outline-success" id="addProductBtn">+ Add Product</button>
      </div>
      <table class="table table-bordered" id="productTable">
        <thead class="table-light">
          <tr>
            <th>Product(s)</th>
            <th>Quantity</th>
            <th>Unit Cost (UGX)</th>
            <th>Subtotal (UGX)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="productRows">
          <tr>
            <td>
              <select name="product[]" class="form-select productSelect" required>
                <option value="">Select Product</option>
                {% for product in products %}
                  <option value="{{ product.id }}">{{ product.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td><input type="number" name="quantity[]" class="form-control quantityInput" min="1" value="1" required></td>
            <td><input type="number" name="unit_cost[]" class="form-control costInput" min="0" step="0.01" required></td>
            <td class="subtotalCell">0</td>
            <td><button type="button" class="btn btn-sm btn-danger removeRowBtn">Remove</button></td>
          </tr>
        </tbody>
      </table>

      <div class="text-end mt-3">
        <h5>Total Cost: <span id="totalCost" class="text-success fw-bold">UGX 0.00</span></h5>
      </div>
    </div>

    <!-- Submit -->
    <div class="text-end">
      <a href="{% url 'purchase_order_list' %}" class="btn btn-outline-secondary">Cancel</a>
      <button type="submit" class="btn btn-success">Save Order</button>
    </div>
  </form>
</div>

<!-- JS Logic -->
<script>
function calculateTotals() {
  let total = 0;
  document.querySelectorAll('#productRows tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.quantityInput').value || 0);
    const cost = parseFloat(row.querySelector('.costInput').value || 0);
    const subtotal = qty * cost;
    row.querySelector('.subtotalCell').innerText = subtotal.toFixed(2);
    total += subtotal;
  });
  document.getElementById('totalCost').innerText = 'UGX ' + total.toLocaleString();
}

document.addEventListener('input', (e) => {
  if (e.target.classList.contains('quantityInput') || e.target.classList.contains('costInput')) {
    calculateTotals();
  }
});

document.getElementById('addProductBtn').addEventListener('click', () => {
  const newRow = document.querySelector('#productRows tr').cloneNode(true);
  newRow.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('productRows').appendChild(newRow);
});

document.addEventListener('click', (e) => {
  if (e.target.classList.contains('removeRowBtn')) {
    e.target.closest('tr').remove();
    calculateTotals();
  }
});

document.getElementById('supplier').addEventListener('change', function() {
  const selected = this.options[this.selectedIndex];
  if (selected.value) {
    document.getElementById('supplierInfo').style.display = 'block';
    document.getElementById('supplierPhone').innerText = selected.dataset.phone || '—';
    document.getElementById('supplierEmail').innerText = selected.dataset.email || '—';
  } else {
    document.getElementById('supplierInfo').style.display = 'none';
  }
});

</script>
{% endblock %}
