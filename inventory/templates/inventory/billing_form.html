{% extends 'inventory/base.html' %}
{% load static %}
{% block title %}Point of Sale (POS) - Supermarket DBMS{% endblock %}
{% block content %}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>Point of Sale (POS)</h2>
    <p class="text-muted mb-0">Create new sale transaction with multiple products</p>
  </div>
  <div class="btn-group">
    <a href="{% url 'sales_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to Sales
    </a>
    <button class="btn btn-outline-info" onclick="clearCart()">
      <i class="fas fa-trash me-2"></i>Clear Cart
    </button>
  </div>
</div>

<!-- POS Interface -->
<div class="row">
  <!-- Product Selection Panel -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Product Selection</h5>
      </div>
      <div class="card-body">
        <!-- Product Search -->
        <div class="row mb-3">
          <div class="col-md-8">
            <input type="text" class="form-control" id="productSearch" placeholder="Search products by name, brand, or category...">
          </div>
          <div class="col-md-4">
            <select id="categoryFilter" class="form-select">
              <option value="">All Categories</option>
              <!-- Categories will be populated by JavaScript -->
            </select>
          </div>
        </div>
        
        <!-- Product Grid -->
        <div class="row" id="productGrid">
          <!-- Products will be loaded dynamically -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cart and Checkout Panel -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Shopping Cart</h5>
      </div>
      <div class="card-body">
        <!-- Cart Items -->
        <div id="cartItems" class="mb-3" style="max-height: 400px; overflow-y: auto;">
          <div class="text-center text-muted py-4">
            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
            <p>No items in cart</p>
          </div>
        </div>
        
        <!-- Cart Summary -->
        <div class="border-top pt-3">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span id="cartSubtotal">UGx. 0</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Discount:</span>
            <span id="cartDiscount" class="text-success">UGx. 0</span>
          </div>
          <div class="d-flex justify-content-between mb-3 fw-bold">
            <span>Total:</span>
            <span id="cartTotal" class="text-primary">UGx. 0</span>
          </div>
        </div>
        
        <!-- Checkout Form -->
        <form method="post" id="checkoutForm">
          {% csrf_token %}
          
          <!-- Sale Information -->
          <div class="mb-3">
            <label class="form-label">Receipt Number</label>
            {{ sale_form.receipt_no }}
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Customer</label>
              {{ sale_form.customer }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Staff</label>
              {{ sale_form.staff }}
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Payment Method</label>
              {{ sale_form.payment_method }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Sale Date</label>
              {{ sale_form.sale_datetime }}
            </div>
          </div>
          
          <!-- Hidden fields for sale details -->
          <div id="hiddenFormFields">
            <!-- Sale details will be added here dynamically -->
          </div>
          
          <!-- Action Buttons -->
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg" id="checkoutBtn" disabled>
              <i class="fas fa-credit-card me-2"></i>Complete Sale
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="saveAsDraft()">
              <i class="fas fa-save me-2"></i>Save as Draft
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Quick Add Product Modal -->
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickAddModalLabel">Add Product to Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="quickAddContent">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAddBtn">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
// Global variables
let cart = [];
let products = [];
let categories = [];
let selectedProduct = null;

// Initialize POS
async function initializePOS() {
  await loadProducts();
  await loadCategories();
  populateCategories();
  displayProducts();
  updateCart();
  
  // Set default values
  document.getElementById('id_receipt_no').value = generateReceiptNumber();
  document.getElementById('id_sale_datetime').value = new Date().toISOString().slice(0, 16);
}

// Load products from API
async function loadProducts() {
  try {
    const response = await fetch('/inventory/api/products/');
    const data = await response.json();
    products = data.products || [];
  } catch (error) {
    console.error('Error loading products:', error);
  }
}

// Load categories
async function loadCategories() {
  try {
    const response = await fetch('/inventory/api/products/');
    const data = await response.json();
    categories = data.categories || [];
  } catch (error) {
    console.error('Error loading categories:', error);
  }
}

// Populate category filter
function populateCategories() {
  const categorySelect = document.getElementById('categoryFilter');
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.id;
    option.textContent = category.name;
    categorySelect.appendChild(option);
  });
}

// Display products
function displayProducts() {
  const productGrid = document.getElementById('productGrid');
  const searchTerm = document.getElementById('productSearch').value.toLowerCase();
  const selectedCategory = document.getElementById('categoryFilter').value;
  
  let filteredProducts = products.filter(product => {
    const matchesSearch = !searchTerm || 
      product.product_name.toLowerCase().includes(searchTerm) ||
      product.brand.toLowerCase().includes(searchTerm) ||
      product.category_name.toLowerCase().includes(searchTerm);
    
    const matchesCategory = !selectedCategory || product.category_id == selectedCategory;
    
    return matchesSearch && matchesCategory && product.stock_quantity > 0;
  });
  
  productGrid.innerHTML = filteredProducts.map(product => `
    <div class="col-md-4 col-sm-6 mb-3">
      <div class="card h-100 product-card" onclick="selectProduct(${product.id})">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-0">${product.product_name}</h6>
            <span class="badge bg-${product.stock_quantity <= product.reorder_level ? 'warning' : 'success'}">
              ${product.stock_quantity} ${product.unit}
            </span>
          </div>
          <p class="card-text text-muted small">${product.brand || 'No brand'}</p>
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-primary">UGx. ${parseFloat(product.retail_price).toLocaleString()}</span>
            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); quickAddProduct(${product.id})">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// Select product for detailed view
function selectProduct(productId) {
  selectedProduct = products.find(p => p.id === productId);
  if (selectedProduct) {
    showQuickAddModal(selectedProduct);
  }
}

// Show quick add modal
function showQuickAddModal(product) {
  const modalBody = document.getElementById('quickAddContent');
  modalBody.innerHTML = `
    <div class="row">
      <div class="col-md-4">
        <div class="text-center">
          <i class="fas fa-box fa-3x text-muted mb-2"></i>
          <h6>${product.product_name}</h6>
          <p class="text-muted">${product.brand || 'No brand'}</p>
        </div>
      </div>
      <div class="col-md-8">
        <div class="mb-3">
          <label class="form-label">Price per ${product.unit}</label>
          <div class="input-group">
            <span class="input-group-text">UGx.</span>
            <input type="number" class="form-control" id="productPrice" value="${product.retail_price}" step="0.01">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Quantity</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" type="button" onclick="adjustQuantity(-1)">-</button>
            <input type="number" class="form-control text-center" id="productQuantity" value="1" min="1" max="${product.stock_quantity}">
            <button class="btn btn-outline-secondary" type="button" onclick="adjustQuantity(1)">+</button>
          </div>
          <small class="form-text text-muted">Available: ${product.stock_quantity} ${product.unit}</small>
        </div>
        <div class="mb-3">
          <label class="form-label">Discount (UGx.)</label>
          <input type="number" class="form-control" id="productDiscount" value="0" min="0" step="0.01">
        </div>
        <div class="alert alert-info">
          <strong>Subtotal:</strong> <span id="productSubtotal">UGx. ${parseFloat(product.retail_price).toLocaleString()}</span>
        </div>
      </div>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('quickAddModal'));
  modal.show();
  
  // Add event listeners for real-time calculation
  document.getElementById('productPrice').addEventListener('input', calculateProductSubtotal);
  document.getElementById('productQuantity').addEventListener('input', calculateProductSubtotal);
  document.getElementById('productDiscount').addEventListener('input', calculateProductSubtotal);
}

// Adjust quantity
function adjustQuantity(change) {
  const quantityInput = document.getElementById('productQuantity');
  const currentQuantity = parseInt(quantityInput.value);
  const newQuantity = Math.max(1, Math.min(selectedProduct.stock_quantity, currentQuantity + change));
  quantityInput.value = newQuantity;
  calculateProductSubtotal();
}

// Calculate product subtotal
function calculateProductSubtotal() {
  const price = parseFloat(document.getElementById('productPrice').value) || 0;
  const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
  const discount = parseFloat(document.getElementById('productDiscount').value) || 0;
  
  const subtotal = (price * quantity) - discount;
  document.getElementById('productSubtotal').textContent = `UGx. ${Math.max(0, subtotal).toLocaleString()}`;
}

// Quick add product (add to cart directly)
function quickAddProduct(productId) {
  const product = products.find(p => p.id === productId);
  if (product) {
    const existingItem = cart.find(item => item.product_id === productId);
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cart.push({
        product_id: productId,
        product_name: product.product_name,
        unit_price: parseFloat(product.retail_price),
        quantity: 1,
        discount: 0
      });
    }
    updateCart();
  }
}

// Confirm add to cart
document.getElementById('confirmAddBtn').addEventListener('click', function() {
  const price = parseFloat(document.getElementById('productPrice').value) || 0;
  const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
  const discount = parseFloat(document.getElementById('productDiscount').value) || 0;
  
  if (selectedProduct) {
    const existingItem = cart.find(item => item.product_id === selectedProduct.id);
    if (existingItem) {
      existingItem.quantity += quantity;
      existingItem.unit_price = price;
      existingItem.discount += discount;
    } else {
      cart.push({
        product_id: selectedProduct.id,
        product_name: selectedProduct.product_name,
        unit_price: price,
        quantity: quantity,
        discount: discount
      });
    }
    
    updateCart();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddModal'));
    modal.hide();
  }
});

// Update cart display
function updateCart() {
  const cartItems = document.getElementById('cartItems');
  const checkoutBtn = document.getElementById('checkoutBtn');
  
  if (cart.length === 0) {
    cartItems.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
        <p>No items in cart</p>
      </div>
    `;
    checkoutBtn.disabled = true;
  } else {
    cartItems.innerHTML = cart.map((item, index) => `
      <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
        <div class="flex-grow-1">
          <h6 class="mb-0">${item.product_name}</h6>
          <small class="text-muted">UGx. ${item.unit_price.toLocaleString()} Ã— ${item.quantity}</small>
          ${item.discount > 0 ? `<small class="text-success d-block">Discount: UGx. ${item.discount.toLocaleString()}</small>` : ''}
        </div>
        <div class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
            <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
            <button class="btn btn-outline-danger" onclick="removeFromCart(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="fw-bold">UGx. ${((item.unit_price * item.quantity) - item.discount).toLocaleString()}</div>
        </div>
      </div>
    `).join('');
    checkoutBtn.disabled = false;
  }
  
  updateCartTotals();
  updateHiddenFormFields();
}

// Update quantity
function updateQuantity(index, change) {
  const item = cart[index];
  const newQuantity = Math.max(1, item.quantity + change);
  
  // Check stock availability
  const product = products.find(p => p.id === item.product_id);
  if (product && newQuantity > product.stock_quantity) {
    alert(`Insufficient stock. Available: ${product.stock_quantity} ${product.unit}`);
    return;
  }
  
  item.quantity = newQuantity;
  updateCart();
}

// Remove from cart
function removeFromCart(index) {
  cart.splice(index, 1);
  updateCart();
}

// Update cart totals
function updateCartTotals() {
  const subtotal = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
  const totalDiscount = cart.reduce((sum, item) => sum + item.discount, 0);
  const total = subtotal - totalDiscount;
  
  document.getElementById('cartSubtotal').textContent = `UGx. ${subtotal.toLocaleString()}`;
  document.getElementById('cartDiscount').textContent = `UGx. ${totalDiscount.toLocaleString()}`;
  document.getElementById('cartTotal').textContent = `UGx. ${Math.max(0, total).toLocaleString()}`;
}

// Update hidden form fields
function updateHiddenFormFields() {
  const hiddenFields = document.getElementById('hiddenFormFields');
  hiddenFields.innerHTML = '';
  
  cart.forEach((item, index) => {
    hiddenFields.innerHTML += `
      <input type="hidden" name="form-${index}-product" value="${item.product_id}">
      <input type="hidden" name="form-${index}-quantity_sold" value="${item.quantity}">
      <input type="hidden" name="form-${index}-unit_price" value="${item.unit_price}">
      <input type="hidden" name="form-${index}-discount_value" value="${item.discount}">
      <input type="hidden" name="form-${index}-sub_total" value="${(item.unit_price * item.quantity) - item.discount}">
    `;
  });
  
  // Add management form data
  hiddenFields.innerHTML += `<input type="hidden" name="form-TOTAL_FORMS" value="${cart.length}">`;
  hiddenFields.innerHTML += `<input type="hidden" name="form-INITIAL_FORMS" value="0">`;
  hiddenFields.innerHTML += `<input type="hidden" name="form-MIN_NUM_FORMS" value="0">`;
  hiddenFields.innerHTML += `<input type="hidden" name="form-MAX_NUM_FORMS" value="1000">`;
}

// Clear cart
function clearCart() {
  if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
    cart = [];
    updateCart();
  }
}

// Generate receipt number
function generateReceiptNumber() {
  const now = new Date();
  const timestamp = now.getFullYear().toString() + 
                   (now.getMonth() + 1).toString().padStart(2, '0') + 
                   now.getDate().toString().padStart(2, '0') + 
                   now.getHours().toString().padStart(2, '0') + 
                   now.getMinutes().toString().padStart(2, '0') + 
                   now.getSeconds().toString().padStart(2, '0');
  return 'RCP' + timestamp;
}

// Save as draft
function saveAsDraft() {
  // This would save the current cart state for later completion
  alert('Draft saved successfully!');
}

// Form submission
document.getElementById('checkoutForm').addEventListener('submit', function(e) {
  if (cart.length === 0) {
    e.preventDefault();
    alert('Please add at least one product to the cart.');
    return false;
  }
  
  // Show loading state
  const submitBtn = document.getElementById('checkoutBtn');
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
  submitBtn.disabled = true;
});

// Event listeners
document.getElementById('productSearch').addEventListener('input', displayProducts);
document.getElementById('categoryFilter').addEventListener('change', displayProducts);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  initializePOS();
});
</script>

<style>
.product-card {
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.product-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.avatar-sm {
  width: 32px;
  height: 32px;
  font-size: 14px;
}

.card {
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.btn {
  border-radius: 0.375rem;
}

.form-control:focus, .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.badge {
  font-size: 0.75em;
}

#cartItems::-webkit-scrollbar {
  width: 6px;
}

#cartItems::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

#cartItems::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

#cartItems::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

{% endblock %}